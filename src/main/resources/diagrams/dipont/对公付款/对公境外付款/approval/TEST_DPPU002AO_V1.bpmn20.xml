<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/fin">
  <process id="DPPU002AO" name="测试练习DPPU002AO对公境外付款 Purchase Payment" isExecutable="true" activiti:candidateStarterGroups="_testdemo,admin">
    <documentation>{ "description": "员工填写对公付款后将由费用对应的成本中心进行审批，通过后将费用凭证PDF打印提交至财务进行后续账务处理。After the employee fill in expense reimbursement, it will be examined and approved by the cost center corresponding to the expense. After the approval, the expense voucher will be printed in PDF and submitted to the financial department for subsequent accounting treatment.", 
	"documents": [{ "name": "EXCEL模板", "path": "https://bpm.dipont.com/images/docs/payment.xlsx", "size": "xlsx" }] }</documentation>
    <startEvent id="S1" name="S1" activiti:initiator="initiator">
      <documentation>用户启动流程，填写对公付款单相应信息 User starts the process and fills in the corresponding information of the purchase payment form</documentation>
      <extensionElements>
        <activiti:formProperty id="corpid_实体 CorpID_1_string_tree_$$A" name="所属实体 CorpID" type="string" variable="corp" required="true"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_3_enum_sbs_$$A" name="货币 Currency" type="enum" variable="currency" required="true">
          <activiti:value id="美元 USD" name="美元 USD"></activiti:value>
          <activiti:value id="日元 JPY" name="日元 JPY"></activiti:value>
          <activiti:value id="澳元 AUD" name="澳元 AUD"></activiti:value>
          <activiti:value id="欧元 EUR" name="欧元 EUR"></activiti:value>
          <activiti:value id="英镑 GBP" name="英镑 GBP"></activiti:value>
          <activiti:value id="港元 HKD" name="港元 HKD"></activiti:value>
          <activiti:value id="澳门币 MOP" name="澳门币 MOP"></activiti:value>
          <activiti:value id="新台币 TWD" name="新台币 TWD"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$B" name="供应商账号 Supplier" type="string" variable="vendor" required="true"></activiti:formProperty>
		
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$B" name="税费承担方 Tax bearer" type="enum" variable="taxbearer" required="true">
          <activiti:value id="汇款人 OUR" name="汇款人 OUR"></activiti:value>
          <activiti:value id="收款人 BEN" name="收款人 BEN"></activiti:value>
        </activiti:formProperty>
		
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$B" name="手续费承担方 Bank fee bearer" type="enum" variable="borneby" required="true">
          <activiti:value id="汇款人 OUR" name="汇款人 OUR"></activiti:value>
          <activiti:value id="收款人 BEN" name="收款人 BEN"></activiti:value>
          <activiti:value id="共同 SHA" name="共同 SHA"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$C" name="合同编号 Contract ID" type="string" variable="contract" required="true"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$C" name="是否提供发票 Invoice" type="enum" variable="ifinvoice" required="true">
          <activiti:value id="有 Y" name="有 Y（If having an electronic version, please upload it to the attachment)"></activiti:value>
        </activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$C" name="是否加急 urgent" type="enum" variable="urgent" required="true">
          <activiti:value id="否 N" name="否 N"></activiti:value>
		  <activiti:value id="是 Y" name="是 Y"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$D" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$F" name="附件" type="string" variable="attachment" required="true"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item" required="true"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$A" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$A" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$A" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$A" name="学科 Subject" type="enum" variable="tbhdpaymentpur002a_discipline">
          <activiti:value id="无" name="无 NA"></activiti:value>
          <activiti:value id="语文" name="语文 Chi."></activiti:value>
          <activiti:value id="数学" name="数学 Math."></activiti:value>
          <activiti:value id="政治" name="政治 Politics"></activiti:value>
          <activiti:value id="英语" name="英语 Eng."></activiti:value>
          <activiti:value id="历史" name="历史 His."></activiti:value>
          <activiti:value id="地理" name="地理 Geo."></activiti:value>
          <activiti:value id="物理" name="物理 Phy."></activiti:value>
          <activiti:value id="生物" name="生物 Bio."></activiti:value>
          <activiti:value id="化学" name="化学 Chem."></activiti:value>
          <activiti:value id="体育" name="体育 P.E."></activiti:value>
          <activiti:value id="美术" name="美术 Art"></activiti:value>
          <activiti:value id="音乐" name="音乐 Music"></activiti:value>
          <activiti:value id="其它" name="其它 Other"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$A" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
      </extensionElements>
    </startEvent>
    <scriptTask id="ST01" name="用户数据预处理" scriptFormat="groovy" activiti:autoStoreVariables="false">
	<script><![CDATA[
	
				def user = identityService.createUserQuery().userId(initiator).singleResult(); 
				execution.setVariable('initiatorname', user.getLastName() + " " + user.getFirstName());
				execution.setVariable('claimsn',initiator); 
				
				def corpsn = new groovy.json.JsonSlurper().parseText(execution.getVariable("corp")).code;
				execution.setVariable('corpname',new groovy.json.JsonSlurper().parseText(execution.getVariable("corp")).name); 
				execution.setVariable('vendorname',new groovy.json.JsonSlurper().parseText(execution.getVariable("vendor")).name);
				execution.setVariable('bankname',execution.getVariable("bank"));
				execution.setVariable("instanceid",execution.getProcessInstanceId());
				if( !execution.getVariable("corrbankname")) {
					execution.setVariable("corrbankname","");
				}
				if( !execution.getVariable("corrbankaddress")) {
					execution.setVariable("corrbankaddress","");
				}				
				
				
				try{
					//def contract = new groovy.json.JsonSlurper().parseText(execution.getVariable("contract"));
					execution.setVariable("contractno",execution.getVariable("contract"));
				}catch(Exception e) {
					execution.setVariable("contractno","NA");
				}
				
				execution.setVariable("claimsubject",execution.getBusinessKey());
				
				//
				execution.setVariable("costcentermemo","");//重置成本中心审批说明
				//计算报销总金额
				def std= new groovy.json.JsonSlurper().parseText(execution.getVariable("tbhdpaymentpur002a_item_std"));
				def costCenterDrools = [];
				def costCenterArray = [];
				def totalamount = 0;
				std.groupBy { item ->
					item.costcenter.code
				}.each{ k,v ->
					costCenterArray << k;
					def costcenterTotalAmount = 0;
					v.each{
						def amount = new java.math.BigDecimal(it.amount).setScale(2, java.math.RoundingMode.HALF_UP);
						costcenterTotalAmount += amount;
					}
					totalamount += costcenterTotalAmount;
					costCenterDrools << """{"costcenter":"${k}","amount":"${costcenterTotalAmount}","corpcode":"${corpsn}"}""".toString();
				}
				
				execution.setVariable("costCenterArray",costCenterArray.unique());
				execution.setVariable("costCenterDrools",costCenterDrools);
				execution.setVariable("totalamount",totalamount+"");
				execution.setVariable("businessKey",execution.getBusinessKey());
				execution.setVariable("verifydate",new Date().getTime()+"");//填表日期
	
				//if(new Long(new Date().getTime()+"") > new Long(execution.getVariable("reqdate")) ) {
				//	throw new org.activiti.engine.ActivitiIllegalArgumentException("要求付款日期必须大于当前日期 Required date must be greater than current date");
				//}
				
				//if(execution.getVariable("currency") == "其它 OTHERS" && execution.getVariable("othercurrency") == null ) {
				//	throw new org.activiti.engine.ActivitiIllegalArgumentException("请填写其它货币 Please fill in other currency");
				//}
				
				//coreaction VIEW 新增成本中心审批历史
				import javax.crypto.Mac;
				import javax.crypto.spec.SecretKeySpec;
				import java.security.InvalidKeyException;
				import java.util.Base64;
				def hmac_sha256(String secretKey, String data) {
					try {
						Mac mac = Mac.getInstance("HmacSHA256");
						SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getBytes(), "HmacSHA256");
						mac.init(secretKeySpec);
						byte[] digest = mac.doFinal(data.getBytes());
						return digest;
					} catch (InvalidKeyException e) {
						throw new RuntimeException("Invalid key exception while converting to HMacSHA256");
					}
				}
				def METABASE_SITE_URL = "https://bpmmb.dipont.com";
				def METABASE_SECRET_KEY = "3c7ece2c2a488065d255402e5bb1729b64ef5a4e37bc2dcbef6a2d327ad55275";
				def header = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9";//Base64.getUrlEncoder().encodeToString('{"typ":"JWT","alg":"HS256"}'.bytes);
				def playloadString = '{"resource":{"question":51},"params":{"param":"'+execution.getProcessInstanceId()+'"}}';
				def playload = Base64.getUrlEncoder().encodeToString(playloadString.bytes);

				def secret =Base64.getUrlEncoder().encodeToString(hmac_sha256(METABASE_SECRET_KEY , header+'.'+playload));
				def url = METABASE_SITE_URL + "/embed/question/" + header+'.'+playload+'.'+secret + "#bordered=true&titled=true";
				execution.setVariable("BBOT_BI_COREACTION",url);



				
				def vendoraccountno = new groovy.json.JsonSlurper().parseText(execution.getVariable("vendor")).code;
				def vendorname = new groovy.json.JsonSlurper().parseText(execution.getVariable("vendor")).name;
				
				//查询供应商类型的参数设置
				execution.setVariable("_http_method", "GET");
				def headerMap = new java.util.HashMap<String,String>();			
				execution.setVariable("_http_headers", headerMap);
				execution.setVariable("_http_body", '');
				def param=java.net.URLEncoder.encode('[{"type":"category","target":["variable",["template-tag","code"]],"value":"'+vendoraccountno+'"},{"type":"category","target":["variable",["template-tag","name"]],"value":"'+vendorname+'"}]', "UTF-8");
				execution.setVariable("_http_url", 'https://bpmmb.dipont.com/public/question/ae9b9d11-0320-477d-b5c2-e0e1225f067e.json?parameters='+param);
				execution.setVariable("_http_response_body", '');
				execution.setVariable("_http_response_status_code", '');
				
				]]></script>
    </scriptTask>
    <serviceTask id="ST02" name="查询供应商信息" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST03" name="处理查询结果" scriptFormat="groovy" activiti:autoStoreVariables="false">
 		      <script><![CDATA[		
				//保存供应商相应信息
				def venderinfo = new groovy.json.JsonSlurper().parseText(execution.getVariable('_http_response_body'))[0];
				
				execution.setVariable('vendortype',venderinfo.TYPE);//保存供应商类型，1代表内部，其余都代表外部客商
				execution.setVariable('beneno',venderinfo.ACCOUNT_NO_);//账号
				execution.setVariable('benebankname',venderinfo.DEPOSIT_BANK_);//银行名称
				execution.setVariable('benebankaddress',venderinfo.BANK_ADDRESS_);//银行地址
				execution.setVariable('payeename',venderinfo.PAYEE_NAME_);//收款人名称
				execution.setVariable('beneaddress',venderinfo.BENE_ADDRESS_);//收款人地址
				execution.setVariable('swiftcode',venderinfo.SWIFT_CODE_);//swiftcode
				execution.setVariable('benecountary',venderinfo.BENE_COUNTARY_);//收款人常驻国家
				execution.setVariable('corrbankname',venderinfo.CORR_BANK_NAME_);//收款银行之代理行名称
				execution.setVariable('corrbankaddress',venderinfo.CORR_BANK_ADDRESS_);//收款银行之代理行地址
		
				execution.setVariable('vendorcode',venderinfo.SUPPLIER_CODE_);//真正的供应商编码
				//查询实体相应信息参数设置
				def corpsn = new groovy.json.JsonSlurper().parseText(execution.getVariable("corp")).code;//实体
				def vendorcode = venderinfo.SUPPLIER_CODE_;//供应商（转账时供应商可能是实体，所以也要去drools里面抓一遍银行账号）
				
				execution.setVariable("_http_method", "POST");
				def headerMap = new java.util.HashMap<String,String>();
				headerMap.put("Content-Type","application/json");				
				execution.setVariable("_http_headers", headerMap);
				def entitys = '[{"entity":"'+corpsn+'"},{"entity":"'+vendorcode+'"}]';
				execution.setVariable("_http_body", entitys);
				execution.setVariable("_http_url", 'https://bpmcs.dipont.com/decisiontables/v1/fire/entitypur002a.xls');
				execution.setVariable("_http_response_body", '');
				execution.setVariable("_http_response_status_code", '');
			]]></script>
    </scriptTask>
    <serviceTask id="ST04" name="查询实体相应信息" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST05" name="处理查询结果" scriptFormat="groovy" activiti:autoStoreVariables="false">
           <script><![CDATA[		
				//保存实体相应信息		
				execution.setVariable("entitydetail",execution.getVariable("_http_response_body"));				
				def entitydetail = new groovy.json.JsonSlurper().parseText(execution.getVariable("_http_response_body"));


				//分析账簿和财务道审批人信息
				def entity = entitydetail.find{it ->it.entity == new groovy.json.JsonSlurper().parseText(execution.getVariable("corp")).code}
			
				def entitytype = entity.entitytype;
				def accountant = entity.accountant;
				def cashier = entity.cashier;
				def remark1 = entity.remark1;
				def remark2 = entity.remark2;
				
				if(!accountant) {
					throw new org.activiti.engine.ActivitiIllegalArgumentException("您所属的实体目前不存在会计审批人，请联系管理员 The entity you belong to does not currently have an accounting approver. Please contact the administrator.");
				}
				if(!cashier) {
					throw new org.activiti.engine.ActivitiIllegalArgumentException("您所属的实体目前不存在出纳审批人，请联系管理员 The entity you belong to does not currently have a cashier approver. Please contact the administrator.");
				}
				//remark2格式为a,b 当会计审批人报销时，会计和出纳审批人分别替换为a，b
				if(remark2){
					if(initiator == accountant) {
						try{
							accountant = remark2.split(",")[0];
							cashier = remark2.split(",")[1];
						}catch(Exception e) {
							throw new org.activiti.engine.ActivitiIllegalArgumentException("会计或出纳设置错误，请联系管理员 The accounting or cashier settings are incorrect, please contact the administrator");
						}
					}
				}
				//remark1格式为a:b,c 当报销单中包含a开头的成本中心时，一般a都是02，会计改成b,出纳改成c
				if(remark1){
					//判断成本中心列表中是否有02开头的，如果有，就替换审批人
					if(execution.getVariable("costCenterArray").any{elem -> elem.startsWith(remark1.split(":")[0])}) {
						try{
							accountant = remark1.split(":")[1].split(",")[0];
							cashier = remark1.split(":")[1].split(",")[1];
						}catch(Exception e) {
							throw new org.activiti.engine.ActivitiIllegalArgumentException("会计或出纳设置错误，请联系管理员 The accounting or cashier settings are incorrect, please contact the administrator");
						}
					}
				}

				execution.setVariable("accountant",accountant);//会计
				execution.setVariable("cashier",cashier);//出纳
				execution.setVariable("entitytype",entitytype);//实体类型（A，B，C）
		  		execution.setVariable("payeraccount",entity.payeraccount);//付款银行账号
				execution.setVariable("payerbank",entity.payerbank);//付款银行
				
				execution.setVariable("accountant",initiator);//会计
				execution.setVariable("cashier",initiator);//出纳	
				

				//查询成本中心类型的参数设置
				execution.setVariable("_http_method", "POST");
				def headerMap = new java.util.HashMap<String,String>();
				headerMap.put("Content-Type","application/json");				
				execution.setVariable("_http_headers", headerMap);

				execution.setVariable("_http_body", execution.getVariable('costCenterDrools').toString());
				execution.setVariable("_http_url", 'https://bpmcs.dipont.com/decisiontables/v1/fire/cctype.xls');
				execution.setVariable("_http_response_body", '');
			    execution.setVariable("_http_response_status_code", '');
			]]></script>
    </scriptTask>
    <serviceTask id="ST06" name="查询成本中心类型" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST07" name="处理查询结果" scriptFormat="groovy" activiti:autoStoreVariables="false">
	      <script><![CDATA[		
				//保存成本中心类型
				execution.setVariable('costCenterType',execution.getVariable('_http_response_body'));
		  
				//查询成本中心审批人参数设置
				execution.setVariable("_http_method", "POST");
				def headerMap = new java.util.HashMap<String,String>();
				headerMap.put("Content-Type","application/json");				
				execution.setVariable("_http_headers", headerMap);

				execution.setVariable("_http_body",execution.getVariable('_http_response_body'));
				execution.setVariable("_http_url", 'https://bpmcs.dipont.com/decisiontables/v1/fire/ccpur002a.xls');
				execution.setVariable("_http_response_body", '');
			    execution.setVariable("_http_response_status_code", '');
			]]></script>
    </scriptTask>
    <serviceTask id="ST08" name="查询成本中心审批人" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST09" name="处理查询结果" scriptFormat="groovy" activiti:autoStoreVariables="false">
       <script><![CDATA[
			//保存成本中心审批人
			execution.setVariable('costCenterDrools',execution.getVariable('_http_response_body'));
			
			//查询会计科目参数设置
			def costCenterType = new groovy.json.JsonSlurper().parseText(execution.getVariable("costCenterType"));
				
			def mapper = new com.fasterxml.jackson.databind.ObjectMapper();
			def std = mapper.readValue(execution.getVariable('tbhdpaymentpur002a_item_std'), new com.fasterxml.jackson.core.type.TypeReference<List<Map<String, Object>>>(){});
			//将成本中心，收支项目等map类型的数据全部将code取出替换原有map，新增type属性，赋值成本中心类型（ABCD）,新增type2属性，赋值成本中心类型（1234）赋值实体类型
			def dealStd = std.each{ elem ->
				elem.each{
					if (it.value instanceof java.util.Map)
						it.value = it.value.code;
				}
				try{elem.type = costCenterType.find { it -> it.costcenter == elem.costcenter}.type;}
				catch(Exception e) 
				{throw new org.activiti.engine.ActivitiIllegalArgumentException("成本中心类型缺失，请联系管理员 The cost center type is missing, please contact the administrator");}
				try{elem.type2 = costCenterType.find { it -> it.costcenter == elem.costcenter}.type2;}catch(Exception e) {throw new org.activiti.engine.ActivitiIllegalArgumentException("成本中心类型缺失，请联系管理员 The cost center type is missing, please contact the administrator");}				
				elem.entitytype = execution.getVariable("entitytype");
			}
			
			//execution.setVariable("dealStd",  groovy.json.JsonOutput.toJson(dealStd));
			
			execution.setVariable("_http_method", "POST");
			def headerMap = new java.util.HashMap<String,String>();
			headerMap.put("Content-Type","application/json");				
			execution.setVariable("_http_headers", headerMap);

			execution.setVariable("_http_body", groovy.json.JsonOutput.toJson(dealStd));
			execution.setVariable("_http_url", 'https://bpmcs.dipont.com/decisiontables/v1/fire/accsubjectpur002a.xls');
			execution.setVariable("_http_response_body", '');
			execution.setVariable("_http_response_status_code", '');
			
     ]]></script>
    </scriptTask>
    <serviceTask id="ST10" name="查询会计科目" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST11" name="处理查询结果" scriptFormat="groovy" activiti:autoStoreVariables="false">
		<script><![CDATA[
				//保存收支项目对应的借方科目和辅助核算项
				def dealStd = execution.getVariable('_http_response_body')
				execution.setVariable("dealStd",dealStd);
				
			

				//设置预算查询参数
				execution.setVariable("_http_method", "GET");
				def headerMap = new java.util.HashMap<String,String>();			
				execution.setVariable("_http_headers", headerMap);
				execution.setVariable("_http_body", '');
				def param=java.net.URLEncoder.encode('[{"type":"category","target":["variable",["template-tag","costcenter_code"]],"value":"'+execution.getVariable("costCenterArray").join(",")+'"},{"type":"category","target":["variable",["template-tag","apply_time"]],"value":'+execution.getVariable("verifydate")+'}]', "UTF-8");
				execution.setVariable("_http_url", 'https://bpmmb.dipont.com/public/question/cf538164-061d-4701-8f5b-684e746ff927.json?parameters='+param);
				execution.setVariable("_http_response_body", '');
				execution.setVariable("_http_response_status_code", '');
		 
     ]]></script>
    </scriptTask>
    <serviceTask id="ST12" name="查询预算" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST13" name="处理查询结果" scriptFormat="groovy" activiti:autoStoreVariables="false">
      <script>
				
			execution.setVariable('allBudget',execution.getVariable('_http_response_body'));
			
			execution.setVariable('costcentermemo',"");
     </script>
    </scriptTask>
    <callActivity id="CA01" name="成本中心审批" calledElement="CA_DPPU002AO">
      <extensionElements>
        <activiti:in sourceExpression="${costCenterArray[loopCounter]}" target="costCenter"></activiti:in>
        <activiti:in sourceExpression="${tbhdpaymentpur002a_item}" target="tbhdpaymentpur002a_item"></activiti:in>
        <activiti:in sourceExpression="${costCenterDrools}" target="costCenterDrools"></activiti:in>
        <activiti:in sourceExpression="${businessKey}" target="businessKey"></activiti:in>
        <activiti:in sourceExpression="${claimsn}" target="claimsn"></activiti:in>
        <activiti:in sourceExpression="${verifydate}" target="verifydate"></activiti:in>
        <activiti:in sourceExpression="${allBudget}" target="allBudget"></activiti:in>
        <activiti:in sourceExpression="${corp}" target="corp"></activiti:in>
        <activiti:in sourceExpression="${currency}" target="currency"></activiti:in>
        <activiti:in sourceExpression="${vendor}" target="vendor"></activiti:in>
		<activiti:in sourceExpression="${taxbearer}" target="taxbearer"></activiti:in>
        <activiti:in sourceExpression="${borneby}" target="borneby"></activiti:in>
        <activiti:in sourceExpression="${contract}" target="contract"></activiti:in>
        <activiti:in sourceExpression="${ifinvoice}" target="ifinvoice"></activiti:in>
        <activiti:in sourceExpression="${remarks}" target="remarks"></activiti:in>
        <activiti:in sourceExpression="${attachment}" target="attachment"></activiti:in>
		<activiti:in sourceExpression="${BBOT_BI_COREACTION}" target="BBOT_BI_COREACTION"></activiti:in>
		
      </extensionElements>
      <multiInstanceLoopCharacteristics isSequential="false">
        <loopCardinality>${costCenterArray.size()}</loopCardinality>
        <completionCondition>${execution.getVariable('coreaction') == '驳回修改 Refuse'}</completionCondition>
      </multiInstanceLoopCharacteristics>
    </callActivity>
    <sequenceFlow id="flow19" name="成本中心拒绝" sourceRef="exclusivegateway1" targetRef="UT05">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction') == '驳回修改 Refuse'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow40" name="成本中心通过" sourceRef="exclusivegateway1" targetRef="ST14">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction') == '同意 Agree'}]]></conditionExpression>
    </sequenceFlow>
    <scriptTask id="ST14" name="预处理数据" scriptFormat="groovy" activiti:autoStoreVariables="false">
 		<script><![CDATA[
			//pdf打印设置
			execution.setVariable("approveddate",new Date().getTime()+"");//审批通过日期
			def costcentermemo = new java.util.ArrayList(java.util.Arrays.asList(execution.getVariable("costcentermemo").split("/"))).unique();
			costcentermemo.removeAll(["null",""]);
			execution.setVariable("costcentermemo",costcentermemo.join("/") + " 审批通过");//各成本中心审批说明
			
			def mapper = new com.fasterxml.jackson.databind.ObjectMapper();
			def printstd = mapper.readValue(execution.getVariable('tbhdpaymentpur002a_item_std'), new com.fasterxml.jackson.core.type.TypeReference<List<Map<String, Object>>>(){});
			def printdetail = printstd.each{ elem ->
				elem.each{
					if (it.value instanceof java.util.Map)
						it.value = it.value.name;
				}
				elem.amount = new java.math.BigDecimal(elem.amount).setScale(2, java.math.RoundingMode.HALF_UP)+"";
			}
			execution.setVariable("printdetail",groovy.json.JsonOutput.toJson(printdetail));
			
			execution.setVariable("bpms_printable",'{"processInstanceId":"'+execution.getProcessInstanceId()+'","templateName":"dp_purchase_o_v1.yml","outputFileName":"DPPU002AO"}');
			
     ]]></script>
    </scriptTask>
    <userTask id="UT01" name="会计审批 Accounting Approval" activiti:assignee="${accountant}" activiti:dueDate="P1D" activiti:priority="8080">
      <extensionElements>
        <activiti:formProperty id="coreaction_审批结果 Approval_1_enum_rbv_$$A" name="审批结果 Approval" type="enum" variable="coreaction_accountant" required="true">
          <activiti:value id="同意 Agree" name="同意 Agree"></activiti:value>
          <activiti:value id="驳回修改 Refuse" name="驳回修改 Refuse"></activiti:value>
          <!-- <activiti:value id="彻底拒绝 Total rejection" name="彻底拒绝 Total rejection"></activiti:value> -->
        </activiti:formProperty>
        <activiti:formProperty id="corecomments_审批意见 Comments_1_string_t2_$$B" name="审批意见 Comments" type="string" variable="corecomments_accountant"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_0_string_cny_$$VA" name="总金额大写 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_1_string_t11_$$VA" name="总金额 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="corpid_实体 CorpID_2_string_tree_$$VA" name="所属实体 CorpID" type="string" variable="corp"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_4_enum_sbs_$$VA" name="货币 Currency" type="string" variable="currency"></activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$VB" name="供应商账号 Supplier" type="string" variable="vendor"></activiti:formProperty>
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$VB" name="税费承担方 Tax bearer" type="string" variable="taxbearer"></activiti:formProperty>
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$VB" name="手续费承担方 Bank fee bearer" type="string" variable="borneby"></activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$VC" name="合同编号 Contract ID" type="string" variable="contract"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$VC" name="是否提供发票 Invoice" type="string" variable="ifinvoice"></activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$VC" name="是否加急 urgent" type="string" variable="urgent"></activiti:formProperty>
		
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$VD" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$VF" name="附件" type="string" variable="attachment"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item_$$VA" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$VA" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$VA" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$VA" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$VA" name="学科 Subject" type="string" variable="tbhdpaymentpur002a_discipline"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$VA" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
        <activiti:taskListener event="create" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:string><![CDATA[//财务及出纳历史审批置空
				task.getExecution().setVariable("coreaction_accountant","");
				task.getExecution().setVariable("corecomments_accountant","");
				task.getExecution().setVariable("coreaction_cashier","");
				task.getExecution().setVariable("corecomments_cashier","");			
			
				
				import javax.crypto.Mac;
				import javax.crypto.spec.SecretKeySpec;
				import java.security.InvalidKeyException;
				import java.util.Base64;
				def hmac_sha256(String secretKey, String data) {
					try {
						Mac mac = Mac.getInstance("HmacSHA256");
						SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getBytes(), "HmacSHA256");
						mac.init(secretKeySpec);
						byte[] digest = mac.doFinal(data.getBytes());
						return digest;
					} catch (InvalidKeyException e) {
						throw new RuntimeException("Invalid key exception while converting to HMacSHA256");
					}
				}
				def METABASE_SITE_URL = "https://bpmmb.dipont.com";
				def METABASE_SECRET_KEY = "3c7ece2c2a488065d255402e5bb1729b64ef5a4e37bc2dcbef6a2d327ad55275";
				def header = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9";//Base64.getUrlEncoder().encodeToString('{"typ":"JWT","alg":"HS256"}'.bytes);
				
				//设置付款和合同历史报表
				def playloadString2 = '{"resource":{"question":19},"params":{"contractnum":"'+task.getExecution().getVariable("contract")+'"}}';
				def playload2 = Base64.getUrlEncoder().encodeToString(playloadString2.bytes);
				def secret2 =Base64.getUrlEncoder().encodeToString(hmac_sha256(METABASE_SECRET_KEY , header+'.'+playload2));
				def url2 = METABASE_SITE_URL + "/embed/question/" + header+'.'+playload2+'.'+secret2 + "#bordered=true&titled=true";
				task.getExecution().setVariable("BBOT_BI_CONTRACTPAY",url2);]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow22" name="会计通过" sourceRef="exclusivegateway2" targetRef="UT02">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_accountant') == '同意 Agree'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow23" name="会计拒绝" sourceRef="exclusivegateway2" targetRef="UT05">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_accountant') == '驳回修改 Refuse'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow31" name="会计彻底拒绝" sourceRef="exclusivegateway2" targetRef="E2">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_accountant') == '彻底拒绝 Total rejection'}]]></conditionExpression>
    </sequenceFlow>
    <userTask id="UT02" name="出纳审批 Cashier Approval" activiti:assignee="${cashier}" activiti:dueDate="P1D" activiti:priority="8080">
      <extensionElements>
        <activiti:formProperty id="coreaction_审批结果 Approval_1_enum_rbv_$$A" name="审批结果 Approval" type="enum" variable="coreaction_cashier" required="true">
          <activiti:value id="同意 Agree" name="同意 Agree"></activiti:value>
          <activiti:value id="驳回修改 Refuse" name="驳回修改 Refuse"></activiti:value>
          <!-- <activiti:value id="彻底拒绝 Total rejection" name="彻底拒绝 Total rejection"></activiti:value> -->
        </activiti:formProperty>
        <activiti:formProperty id="corecomments_审批意见 Comments_1_string_t2_$$B" name="审批意见 Comments" type="string" variable="corecomments_cashier"></activiti:formProperty>
        <activiti:formProperty id="totalcnyamount_人民币总金额 Total Amount CNY_1_string_cny_$$C" name="人民币总金额 Total Amount CNY" type="string" variable="totalCnyAmount" required="true"></activiti:formProperty>
        <activiti:formProperty id="totalprocedurefee_手续费 Procedure Fee_2_string_cny_$$C" name="手续费 Procedure Fee" type="string" variable="totalProcedureFee" required="true"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_0_string_cny_$$VA" name="总金额大写 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_1_string_t11_$$VA" name="总金额 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="corpid_实体 CorpID_2_string_tree_$$VA" name="所属实体 CorpID" type="string" variable="corp"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_4_enum_sbs_$$VA" name="货币 Currency" type="string" variable="currency"></activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$VB" name="供应商账号 Supplier" type="string" variable="vendor"></activiti:formProperty>
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$VB" name="税费承担方 Tax bearer" type="string" variable="taxbearer"></activiti:formProperty>
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$VB" name="手续费承担方 Bank fee bearer" type="string" variable="borneby"></activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$VC" name="合同编号 Contract ID" type="string" variable="contract"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$VC" name="是否提供发票 Invoice" type="string" variable="ifinvoice"></activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$VC" name="是否加急 urgent" type="string" variable="urgent"></activiti:formProperty>
		
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$VD" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$VF" name="附件" type="string" variable="attachment"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item_$$VA" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$VA" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$VA" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$VA" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$VA" name="学科 Subject" type="string" variable="tbhdpaymentpur002a_discipline"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$VA" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow26" name="出纳通过" sourceRef="exclusivegateway3" targetRef="ST15">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_cashier') == '同意 Agree'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow29" name="出纳拒绝" sourceRef="exclusivegateway3" targetRef="UT05">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_cashier') == '驳回修改 Refuse'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow32" name="出纳彻底拒绝" sourceRef="exclusivegateway3" targetRef="E3">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_cashier') == '彻底拒绝 Total rejection'}]]></conditionExpression>
    </sequenceFlow>
    <scriptTask id="ST15" name="处理vocharmap" scriptFormat="groovy" activiti:autoStoreVariables="false">
 		<script><![CDATA[
				def entitydetail = new groovy.json.JsonSlurper().parseText(execution.getVariable("entitydetail"));
				def entity = entitydetail.find{it ->it.entity == new groovy.json.JsonSlurper().parseText(execution.getVariable("corp")).code};
				def vendorcode =  execution.getVariable("vendorcode");
				def vendorFromDools = entitydetail.find{it ->it.entity == vendorcode};
				def vendortype = execution.getVariable("vendortype");//供应商类型，1代表关联，其余代表非关联
				def ifinvoice = execution.getVariable("ifinvoice");//是否提供发票（有，晚些提供，无）
				
				def totalAmount = execution.getVariable('totalamount');
				def totalCnyAmount = execution.getVariable('totalCnyAmount');//rmb换算总金额
				def totalCnyAmountWithoutLast = 0;//rmb换算总金额（不包含最后一条数据）
				def totalProcedureFee = execution.getVariable('totalProcedureFee'); //手续费
				def totalprocedureFeeWithoutLast = 0; //手续费（不包含最后一条数据）
				def costCenterDrools =  new groovy.json.JsonSlurper().parseText(execution.getVariable('costCenterDrools'));
				
				def dealStd = execution.getVariable("dealStd");
				//借贷科目合并，为凭证做准备
				def mapper = new com.fasterxml.jackson.databind.ObjectMapper();
				def inputList = mapper.readValue(dealStd, new com.fasterxml.jackson.core.type.TypeReference<List<Map<String, Object>>>(){});
				
			
				inputList.eachWithIndex{ elem,i ->
					//外币金额和rmb转换
					if( new java.math.BigDecimal(totalCnyAmount) > 0 ){
						if(i == inputList.size()-1) {
							elem.fcamount = elem.amount; //外币金额
							def amount = new java.math.BigDecimal(totalCnyAmount).subtract(new java.math.BigDecimal(totalCnyAmountWithoutLast)).setScale(2, java.math.RoundingMode.HALF_UP);
							elem.amount = amount;
						}else{
							elem.fcamount = elem.amount; //外币金额
							def amount = new java.math.BigDecimal(elem.amount).multiply(new java.math.BigDecimal(totalCnyAmount)).divide(new java.math.BigDecimal(totalAmount),2, java.math.RoundingMode.HALF_UP);
							elem.amount =  amount;
							totalCnyAmountWithoutLast += amount;
						}
					}else{
						throw new org.activiti.engine.ActivitiIllegalArgumentException("人民币总金额不能小于等于0，请重新输入 The total amount of RMB cannot be less than or equal to 0, please re-enter");
					}
				}

				
				//成本中心分摊手续费
				costCenterDrools.eachWithIndex{ elem,i ->
					if( new java.math.BigDecimal(totalProcedureFee) > 0 ){
						if(i == costCenterDrools.size()-1) {
							def procedureFee = new java.math.BigDecimal(totalProcedureFee).subtract(new java.math.BigDecimal(totalprocedureFeeWithoutLast)).setScale(2, java.math.RoundingMode.HALF_UP);

							def procedureFeeList = new java.util.HashMap<String, Object>();
							procedureFeeList.put("ioitem", "1000000000000");//收支项目，（目前写死1000000000000）
							procedureFeeList.put("debitacc", "660301");//借方科目（手续费）
							procedureFeeList.put("dassist", "project,costcenter,profitacc");//手续费借方辅助核算（项目，成本中心，利润中心）
							procedureFeeList.put("costcenter", elem.costcenter);
							procedureFeeList.put("project", "99");//项目（目前写死无）
							procedureFeeList.put("amount",procedureFee);
							procedureFeeList.put("fcamount",procedureFee);
							inputList << procedureFeeList;
						}else{
							def procedureFee = new java.math.BigDecimal(elem.amount).multiply(new java.math.BigDecimal(totalProcedureFee)).divide(new java.math.BigDecimal(totalAmount),2,java.math.RoundingMode.HALF_UP);
							totalprocedureFeeWithoutLast += procedureFee;

							def procedureFeeList = new java.util.HashMap<String, Object>();
							procedureFeeList.put("ioitem", "1000000000000");//收支项目，（目前写死1000000000000）
							procedureFeeList.put("debitacc", "660301");//借方科目（手续费）
							procedureFeeList.put("dassist", "project,costcenter,profitacc");//手续费借方辅助核算（项目，成本中心，利润中心）
							procedureFeeList.put("costcenter", elem.costcenter);
							procedureFeeList.put("project", "99");//项目（目前写死无）
							procedureFeeList.put("amount",procedureFee);
							procedureFeeList.put("fcamount",procedureFee);
							inputList << procedureFeeList;
						}
					}
				}
				
				def assistMap = [category:"0041",people:"0002",partner:"0004",ioitem:"0008",project:"0010",bankacc:"0011",profitacc:"0037",costcenter:"ra01",tobankacc:"0011"]; //tobankacc代表供应商银行账号
				def stdNew = inputList.each{ elem ->
				
					elem.partner = vendorcode;
					elem.bankacc = entity.accountno;
					elem.tobankacc = vendorFromDools.accountno;
					//elem.profitacc = "Z"+elem.costcenter.substring(0,2);
					elem.profitacc = costCenterDrools.find{it.costcenter == elem.costcenter}.profit;	//利润中心，一般都是Z+成本中心前两位,但是后面又自说自话出现了个例，不得不重新在drools中配置
					
					if(!(elem.ioitem.startsWith("50") || elem.ioitem == "3004") && (elem.debitacc == '' || elem.debitacc ==null) ) {
						throw new org.activiti.engine.ActivitiIllegalArgumentException("您所选择的收支项目对应的会计科目未维护业务规则，请联系业务规则方或系统管理员 If the accounting account corresponding to the income and expenditure item you selected does not maintain business rules, please contact the business rule party or system administrator.");
					}

					if((elem.ioitem.startsWith("30") || elem.ioitem.startsWith("40") || elem.ioitem.startsWith("50")) && ifinvoice!="无") {
					    throw new org.activiti.engine.ActivitiIllegalArgumentException("收支项目中包含公司往来或金融产品或退费，此些项目无需发票。请将这些项目删除后重新提交，或者(是否提供发票)选择无！");
					}

					if(elem.ioitem.startsWith("50")) {
						if(elem.ioitem == "5001") {
							elem.creditacc = "220302";
							elem.cassist = "costcenter,partner,project,profitacc";
						}
						if(elem.ioitem == "5002") {
							elem.creditacc = "220304";
							elem.cassist = "costcenter,partner,project,profitacc";
						}
						elem.creditaccsec = "1002";
						elem.cassistsec = "bankacc";
					}
					else if (elem.ioitem.startsWith("40")) {
						if(elem.debitacc == "1002") {
							elem.creditacc = "122201";
							//elem.cassist = "";//如果没有辅助核算项，那么就不要设置，如果设置成"",后面split会有问题
						}else{
							elem.creditacc = "1002";
							elem.cassist = "bankacc";
						}
					}
					else if (elem.ioitem.startsWith("30")) {
						if(elem.ioitem == "3004"){
							if (elem.transtype == "银行到支付宝") {
								elem.debitacc = "101201"//借支付宝
								elem.dassist = "tobankacc"
								elem.creditacc = "1002";//贷银行存款
								elem.cassist = "bankacc";
							}else if (elem.transtype == "银行到微信") {
								elem.debitacc = "101202"//借微信
								elem.dassist = "tobankacc"
								elem.creditacc = "1002";//贷银行存款
								elem.cassist = "bankacc";
							}else if (elem.transtype == "支付宝到银行") {
								elem.debitacc = "1002"//借银行存款
								elem.dassist = "tobankacc"
								elem.creditacc = "101201";//贷支付宝
								elem.cassist = "bankacc";
							}else {//微信到银行
								elem.debitacc = "1002"//借银行存款
								elem.dassist = "tobankacc"
								elem.creditacc = "101202";//贷微信
								elem.cassist = "bankacc";
							}
						} else {
							elem.creditacc = "1002";
							elem.cassist = "bankacc";
						}
					}
					else if (elem.ioitem == "1000000000000") {//手续费
							//elem.creditacc = "1002";
							//elem.cassist = "bankacc";
							elem.creditaccsec = "1002";//银行存款（贷）因为现在1002都在第二条分录里面计算，所以没办法，此处设置了creditaccsec，由于境外的肯定是两条分录同时推送，所以没有影响
							elem.cassistsec = "bankacc";
					}
					else {//10,20,60收支项目
						if(ifinvoice != "晚些提供 Provide late") {//同时提交发票
							if(vendortype == "1") {//如果供应商为关联方
								elem.creditacc = "220202";
								elem.cassist = "partner,profitacc";
								elem.debitaccsec = "220202";
								elem.dassistsec = "partner,profitacc";
							}
							else {//非关联方
								elem.creditacc = "220201";
								elem.cassist = "partner,profitacc";
								elem.debitaccsec = "220201";
								elem.dassistsec = "partner,profitacc";
							}
							elem.creditaccsec = "1002";//银行存款（贷）
							elem.cassistsec = "bankacc";
							
							if(elem.ioitem == "6001" || elem.ioitem == "6002"){  //有发票并且当收支项目为固定资产和无形资产时，不计入第一条分录
								elem.debitacc = "";
								elem.creditacc = "";
							}
							
						}else{//晚些提供
							if(vendortype == "1") {//如果供应商为关联方
								elem.creditacc = "112302";
								//elem.cassist = "";
								elem.debitaccsec = "112302";
								//elem.dassistsec = "";
							}
							else {//非关联方
								elem.creditacc = "112301";
								elem.cassist = "partner,profitacc";
								elem.debitaccsec = "112301";
								elem.dassistsec = "partner,profitacc";
							}
							elem.creditaccsec = "1002";//银行存款（贷）
							elem.cassistsec = "bankacc";
						}
					}
					def dassistList = [],dassistListSec = [],cassistList = [],cassistListSec = [];

					try
					{elem.dassist.split(',').collect{it}.each{ item ->
							def dassistMap = new java.util.HashMap<String, Object>();
							dassistMap.put(assistMap."$item", elem."$item");
							dassistList << dassistMap;
						}
						elem.dassist = dassistList.sort();}
					catch(Exception e)
					{elem.dassist =[];}


					try
					{elem.dassistsec.split(',').collect{it}.each{ item ->
							def dassistMap = new java.util.HashMap<String, Object>();
							dassistMap.put(assistMap."$item", elem."$item");
							dassistListSec << dassistMap;
						}
						elem.dassistsec = dassistListSec.sort();}
					catch(Exception e)
					{elem.dassistsec =[];}

					try
					{elem.cassist.split(',').collect{it}.each{ item ->
							def cassistMap = new java.util.HashMap<String, Object>();
							cassistMap.put(assistMap."$item", elem."$item");
							cassistList << cassistMap;
						}
						elem.cassist = cassistList.sort();}
					catch(Exception e)
					{elem.cassist  =[];}

					try
					{elem.cassistsec.split(',').collect{it}.each{ item ->
							def cassistMap = new java.util.HashMap<String, Object>();
							cassistMap.put(assistMap."$item", elem."$item");
							cassistListSec << cassistMap;
						}
						elem.cassistsec = cassistListSec.sort();}
					catch(Exception e)
					{elem.cassistsec  =[];
					}
				}

				def debitList = [],creditList = []; //付款完成时同时生成2条分录
				def debitListBefore = [],creditListBefore = [],debitListAfter = [],creditListAfter = [];//付款完成时生成一条分录 ，发票上传后再生成一条分录，仅限于10，20，60开头的收支项目
				stdNew.groupBy{ it.subMap('debitacc', 'dassist')}.each{ k,v ->
					if(k.debitacc != "" && k.debitacc != null) {
						def totalamount = 0;
						def fctotalamount = 0;//外币金额
						v.each {
							it.amount = new java.math.BigDecimal(it.amount).setScale(2, java.math.RoundingMode.HALF_UP);
							totalamount += it.amount;
							
							it.fcamount = new java.math.BigDecimal(it.fcamount).setScale(2, java.math.RoundingMode.HALF_UP);
							fctotalamount += it.fcamount;
						}
						def debitMap = new java.util.HashMap<String, Object>();
						debitMap.put(v[0].debitacc,[amount:totalamount,fcamount:fctotalamount,dassist:v[0].dassist]);
						debitList << debitMap;
						debitListAfter << debitMap;
					}
				}
				stdNew.groupBy{ it.subMap('debitaccsec', 'dassistsec')}.each{ k,v ->
					if(k.debitaccsec != "" && k.debitaccsec != null) {
						def totalamount = 0;
						def fctotalamount = 0;//外币金额
						v.each {
							it.amount = new java.math.BigDecimal(it.amount).setScale(2, java.math.RoundingMode.HALF_UP);
							totalamount += it.amount;
							
							it.fcamount = new java.math.BigDecimal(it.fcamount).setScale(2, java.math.RoundingMode.HALF_UP);
							fctotalamount += it.fcamount;
						}
						def debitMap = new java.util.HashMap<String, Object>();
						debitMap.put(v[0].debitaccsec,[amount:totalamount,fcamount:fctotalamount,dassist:v[0].dassistsec]);
						debitList << debitMap;
						debitListBefore << debitMap;
					}
				}
				stdNew.groupBy{ it.subMap('creditacc', 'cassist')}.each{ k,v ->
					if(k.creditacc != "" && k.creditacc != null) {
						def totalamount = 0;
						def fctotalamount = 0;//外币金额
						v.each {
							it.amount = new java.math.BigDecimal(it.amount).setScale(2, java.math.RoundingMode.HALF_UP);
							it.fcamount = new java.math.BigDecimal(it.fcamount).setScale(2, java.math.RoundingMode.HALF_UP);
							
							if(v[0].ioitem == "5001" || v[0].ioitem == "5002") {
								totalamount -= it.amount;
								fctotalamount -= it.fcamount;
							}else {
								totalamount += it.amount;
								fctotalamount += it.fcamount;
							}
						}
						def creditMap = new java.util.HashMap<String, Object>();
						creditMap.put(v[0].creditacc,[amount:totalamount,fcamount:fctotalamount,cassist:v[0].cassist]);
						creditList << creditMap;
						creditListAfter << creditMap;
					}
				}
				stdNew.groupBy{ it.subMap('creditaccsec', 'cassistsec')}.each{ k,v ->
					if(k.creditaccsec != "" && k.creditaccsec != null) {
						def totalamount = 0;
						def fctotalamount = 0;//外币金额
						v.each {
							it.amount = new java.math.BigDecimal(it.amount).setScale(2, java.math.RoundingMode.HALF_UP);
							totalamount += it.amount;
							
							it.fcamount = new java.math.BigDecimal(it.fcamount).setScale(2, java.math.RoundingMode.HALF_UP);
							fctotalamount += it.fcamount;
						}
						def creditMap = new java.util.HashMap<String, Object>();
						creditMap.put(v[0].creditaccsec,[amount:totalamount,fcamount:fctotalamount,cassist:v[0].cassistsec]);
						creditList << creditMap;
						creditListBefore << creditMap;
					}
				}
				
				def currencyCode = execution.getVariable("currency").split(" ")[1];
				if(ifinvoice != "晚些提供 Provide late") {
					def vocherMap = [explanation:execution.getVariable('businessKey')+"@@"+execution.getVariable('initiatorname')+"@@"+execution.getProcessInstanceId(),currencyCode:currencyCode,verifydate:execution.getVariable('verifydate'),org:entity.entity,createUser:entity.createuser,accountingbook:entity.accountingbook,debit:debitList,credit:creditList];
					try
						{execution.setVariable('vocherMapString',groovy.json.JsonOutput.toJson(vocherMap));}
					catch(Exception e) 
						{throw new org.activiti.engine.ActivitiIllegalArgumentException("收支项目对应的辅助核算项存在异常，请联系管理员 The auxiliary accounting item corresponding to the income and expenditure item is abnormal. Please contact the administrator.");}
				}
				else{
					def vocherMap = [explanation:execution.getVariable('businessKey')+"@@"+execution.getVariable('initiatorname')+"@@"+execution.getProcessInstanceId(),currencyCode:currencyCode,verifydate:execution.getVariable('verifydate'),org:entity.entity,createUser:entity.createuser,accountingbook:entity.accountingbook,debit:debitListBefore,credit:creditListBefore];
					def vocherMapAfter = [explanation:execution.getVariable('businessKey')+"@@"+execution.getVariable('initiatorname')+"@@"+execution.getProcessInstanceId(),currencyCode:currencyCode,verifydate:execution.getVariable('verifydate'),org:entity.entity,createUser:entity.createuser,accountingbook:entity.accountingbook,debit:debitListAfter,credit:creditListAfter];
					try
						{
						execution.setVariable('vocherMapString',groovy.json.JsonOutput.toJson(vocherMap));
						execution.setVariable('vocherMapAfterString',groovy.json.JsonOutput.toJson(vocherMapAfter));
						}
					catch(Exception e) 
						{throw new org.activiti.engine.ActivitiIllegalArgumentException("收支项目对应的辅助核算项存在异常，请联系管理员 The auxiliary accounting item corresponding to the income and expenditure item is abnormal. Please contact the administrator.");}
				}
				
			execution.setVariable("_http_method", "POST");
			def headerMap = new java.util.HashMap<String,String>();				
			execution.setVariable("_http_headers", headerMap);
			execution.setVariable("_http_body", '');
			execution.setVariable("_http_url", 'https://bpmcs.dipont.com/decisiontables/v1/integrate/'+execution.getProcessInstanceId()+'/vocherMapString/with/voucher_overseas.xml');
			execution.setVariable("_http_response_body", '');
			execution.setVariable("_http_response_status_code", '');
     ]]></script>
    </scriptTask>
    <serviceTask id="ST16" name="生成凭证" activiti:async="true" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <scriptTask id="ST17" name="校验凭证是否生成" scriptFormat="groovy" activiti:autoStoreVariables="false">
		<script><![CDATA[
				if(execution.getVariable('_http_response_status_code')!= 200){
					//def errorMessage = new XmlParser().parseText(execution.getVariable('_http_response_body').replaceAll("\\<\\?xml(.+?)\\?\\>", "").trim()).sendresult.resultdescription.text();
					throw new org.activiti.engine.delegate.BpmnError("请联系管理员");
				}
     ]]></script>
    </scriptTask>
    <boundaryEvent id="boundaryerror1" name="Error" attachedToRef="ST17">
      <errorEventDefinition></errorEventDefinition>
    </boundaryEvent>
    <userTask id="UT07" name="生成凭证错误,出纳重新审批 Cashier Retry" activiti:assignee="${cashier}" activiti:dueDate="P1D" activiti:priority="8080">
      <extensionElements>
        <activiti:formProperty id="coreaction_审批结果 Approval_1_enum_rbv_$$A" name="审批结果 Approval" type="enum" variable="coreaction_cashier" required="true">
          <activiti:value id="同意 Agree" name="同意 Agree"></activiti:value>
          <activiti:value id="驳回修改 Refuse" name="驳回修改 Refuse"></activiti:value>
          <!-- <activiti:value id="彻底拒绝 Total rejection" name="彻底拒绝 Total rejection"></activiti:value> -->
        </activiti:formProperty>
        <activiti:formProperty id="corecomments_审批意见 Comments_1_string_t2_$$B" name="审批意见 Comments" type="string" variable="corecomments_cashier"></activiti:formProperty>
        <activiti:formProperty id="totalcnyamount_人民币总金额 Total Amount CNY_1_string_cny_$$C" name="人民币总金额 Total Amount CNY" type="string" variable="totalCnyAmount" required="true"></activiti:formProperty>
        <activiti:formProperty id="totalprocedurefee_手续费 Procedure Fee_2_string_cny_$$C" name="手续费 Procedure Fee" type="string" variable="totalProcedureFee" required="true"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_0_string_cny_$$VA" name="总金额大写 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_1_string_t11_$$VA" name="总金额 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="corpid_实体 CorpID_2_string_tree_$$VA" name="所属实体 CorpID" type="string" variable="corp"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_4_enum_sbs_$$VA" name="货币 Currency" type="string" variable="currency"></activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$VB" name="供应商账号 Supplier" type="string" variable="vendor"></activiti:formProperty>
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$VB" name="税费承担方 Tax bearer" type="string" variable="taxbearer"></activiti:formProperty>
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$VB" name="手续费承担方 Bank fee bearer" type="string" variable="borneby"></activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$VC" name="合同编号 Contract ID" type="string" variable="contract"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$VC" name="是否提供发票 Invoice" type="string" variable="ifinvoice"></activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$VC" name="是否加急 urgent" type="string" variable="urgent"></activiti:formProperty>
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$VD" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$VF" name="附件" type="string" variable="attachment"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item_$$VA" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$VA" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$VA" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$VA" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$VA" name="学科 Subject" type="string" variable="tbhdpaymentpur002a_discipline"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$VA" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow34" name="补录发票" sourceRef="exclusivegateway4" targetRef="UT04">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('ifinvoice') == '晚些提供 Provide late'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow35" name="无需补录发票" sourceRef="exclusivegateway4" targetRef="E1">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('ifinvoice') != '晚些提供 Provide late'}]]></conditionExpression>
    </sequenceFlow>
    <userTask id="UT04" name="补录发票 Save invoice" activiti:assignee="${initiator}" activiti:dueDate="P1D" activiti:priority="8080">
      <extensionElements>
        <activiti:formProperty id="totalamount_总金额 Total Amount_0_string_cny_$$VA" name="总金额大写 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_1_string_t11_$$VA" name="总金额 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="corpid_实体 CorpID_2_string_tree_$$VA" name="所属实体 CorpID" type="string" variable="corp"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_4_enum_sbs_$$VA" name="货币 Currency" type="string" variable="currency"></activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$VB" name="供应商账号 Supplier" type="string" variable="vendor"></activiti:formProperty>
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$VB" name="税费承担方 Tax bearer" type="string" variable="taxbearer"></activiti:formProperty>
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$VB" name="手续费承担方 Bank fee bearer" type="string" variable="borneby"></activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$VC" name="合同编号 Contract ID" type="string" variable="contract"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$VC" name="是否提供发票 Invoice" type="string" variable="ifinvoice"></activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$VC" name="是否加急 urgent" type="string" variable="urgent"></activiti:formProperty>
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$VD" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$VF" name="附件" type="string" variable="attachment"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item_$$VA" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$VA" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$VA" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$VA" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$VA" name="学科 Subject" type="string" variable="tbhdpaymentpur002a_discipline"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$VA" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$F" name="附件" type="string" variable="attachment"></activiti:formProperty>
        <activiti:taskListener event="complete" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:string><![CDATA[task.getExecution().setVariable("_http_method", "POST");
				def headerMap = new java.util.HashMap<String,String>();				
				task.getExecution().setVariable("_http_headers", headerMap);
				task.getExecution().setVariable("_http_body", '');
				task.getExecution().setVariable("_http_url", 'https://bpmcs.dipont.com/decisiontables/v1/integrate/'+task.getExecution().getProcessInstanceId()+'/vocherMapAfterString/with/voucher_overseas.xml');
				task.getExecution().setVariable("_http_response_body", '');
				task.getExecution().setVariable("_http_response_status_code", '');]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <serviceTask id="ST18" name="补录发票后生成凭证" activiti:class="com.eorionsolution.riying.bpms.javaservice.http.RestAPIService"></serviceTask>
    <userTask id="UT06" name="会计签收发票 Receipt invoice" activiti:assignee="${accountant}" activiti:dueDate="P1D" activiti:priority="8080">
      <extensionElements>
        <activiti:formProperty id="coreaction_审批结果 Approval_1_enum_rbv_$$A" name="审批结果 Approval" type="enum" variable="coreaction_accountant2" required="true">
          <activiti:value id="同意 Agree" name="同意 Agree"></activiti:value>
          <activiti:value id="驳回修改 Refuse" name="驳回修改 Refuse"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="corecomments_审批意见 Comments_1_string_t2_$$B" name="审批意见 Comments" type="string" variable="corecomments_accountant2"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_0_string_cny_$$VA" name="总金额大写 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="totalamount_总金额 Total Amount_1_string_t11_$$VA" name="总金额 Total Amount" type="string" variable="totalamount"></activiti:formProperty>
        <activiti:formProperty id="corpid_实体 CorpID_2_string_tree_$$VA" name="所属实体 CorpID" type="string" variable="corp"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_4_enum_sbs_$$VA" name="货币 Currency" type="string" variable="currency"></activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$VB" name="供应商账号 Supplier" type="string" variable="vendor"></activiti:formProperty>
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$VB" name="税费承担方 Tax bearer" type="string" variable="taxbearer"></activiti:formProperty>
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$VB" name="手续费承担方 Bank fee bearer" type="string" variable="borneby"></activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$VC" name="合同编号 Contract ID" type="string" variable="contract"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$VC" name="是否提供发票 Invoice" type="string" variable="ifinvoice"></activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$VC" name="是否加急 urgent" type="string" variable="urgent"></activiti:formProperty>
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$VD" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$VF" name="附件" type="string" variable="attachment"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item_$$VA" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$VA" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$VA" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$VA" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$VA" name="学科 Subject" type="string" variable="tbhdpaymentpur002a_discipline"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$VA" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow43" name="同意签收发票" sourceRef="exclusivegateway5" targetRef="ST18">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_accountant2') == '同意 Agree'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow44" name="拒绝签收发票" sourceRef="exclusivegateway5" targetRef="UT04">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction_accountant2') == '驳回修改 Refuse'}]]></conditionExpression>
    </sequenceFlow>
    <userTask id="UT05" name="驳回后修改 Claim Update" activiti:assignee="${initiator}" activiti:dueDate="P1D" activiti:priority="8080">
      <extensionElements>
        <activiti:formProperty id="corpid_实体 CorpID_1_string_tree_$$A" name="所属实体 CorpID" type="string" variable="corp" required="true"></activiti:formProperty>
        <activiti:formProperty id="currency_货币 Currency_3_enum_sbs_$$A" name="货币 Currency" type="enum" variable="currency" required="true">
          <activiti:value id="美元 USD" name="美元 USD"></activiti:value>
          <activiti:value id="日元 JPY" name="日元 JPY"></activiti:value>
          <activiti:value id="澳元 AUD" name="澳元 AUD"></activiti:value>
          <activiti:value id="欧元 EUR" name="欧元 EUR"></activiti:value>
          <activiti:value id="英镑 GBP" name="英镑 GBP"></activiti:value>
          <activiti:value id="港元 HKD" name="港元 HKD"></activiti:value>
          <activiti:value id="澳门币 MOP" name="澳门币 MOP"></activiti:value>
          <activiti:value id="新台币 TWD" name="新台币 TWD"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="vendoraccount_供应商账号 Supplier_1_string_auto_$$B" name="供应商账号 Supplier" type="string" variable="vendor" required="true"></activiti:formProperty>
		<activiti:formProperty id="taxbearer_税费承担方 Tax bearer_8_enum_sbs_$$B" name="税费承担方 Tax bearer" type="enum" variable="taxbearer" required="true">
          <activiti:value id="汇款人 OUR" name="汇款人 OUR"></activiti:value>
          <activiti:value id="收款人 BEN" name="收款人 BEN"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="borneby_手续费承担方 Bank fee bearer_9_enum_sbs_$$B" name="手续费承担方 Bank fee bearer" type="enum" variable="borneby" required="true">
          <activiti:value id="汇款人 OUR" name="汇款人 OUR"></activiti:value>
          <activiti:value id="收款人 BEN" name="收款人 BEN"></activiti:value>
          <activiti:value id="共同 SHA" name="共同 SHA"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="contractno_合同编号 Contract ID_1_string_t1_$$C" name="合同编号 Contract ID" type="string" variable="contract" required="true"></activiti:formProperty>
        <activiti:formProperty id="ifinvoice_是否提供发票 Invoice_2_enum_sbs_$$C" name="是否提供发票 Invoice" type="enum" variable="ifinvoice" required="true">
          <activiti:value id="有 Y" name="有 Y（If having an electronic version, please upload it to the attachment)"></activiti:value>
        </activiti:formProperty>
		<activiti:formProperty id="urgent_是否加急 urgent_3_enum_sbs_$$C" name="是否加急 urgent" type="enum" variable="urgent" required="true">
          <activiti:value id="否 N" name="否 N"></activiti:value>
		  <activiti:value id="是 Y" name="是 Y"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="remarks_摘要说明 Comments_1_string_t1_$$D" name="摘要说明 Comments" type="string" variable="remarks"></activiti:formProperty>
        <activiti:formProperty id="attachment_附件_1_string_t9_$$F" name="附件" type="string" variable="attachment" required="true"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_item" name="付款明细 Detail" type="string" variable="tbhdpaymentpur002a_item" required="true"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_收支项目 Payment item_ioitem_0_string_tree_$$VA" name="收支项目 Payment item" type="string" variable="tbhdpaymentpur002a_ioitem"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_成本中心 Costcenter_costcenter_1_string_tree_$$A" name="成本中心 Costcenter" type="string" variable="tbhdpaymentpur002a_costcenter"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_项目 Project_project_2_string_tree_$$A" name="项目 Project" type="string" variable="tbhdpaymentpur002a_project"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_付款金额 Amount_amount_5_string_cny_$$A" name="付款金额 Amount" type="string" variable="tbhdpaymentpur002a_amount"></activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_学科 Subject_discipline_7_enum_sbs_$$A" name="学科 Subject" type="enum" variable="tbhdpaymentpur002a_discipline">
          <activiti:value id="无" name="无 NA"></activiti:value>
          <activiti:value id="语文" name="语文 Chi."></activiti:value>
          <activiti:value id="数学" name="数学 Math."></activiti:value>
          <activiti:value id="政治" name="政治 Politics"></activiti:value>
          <activiti:value id="英语" name="英语 Eng."></activiti:value>
          <activiti:value id="历史" name="历史 His."></activiti:value>
          <activiti:value id="地理" name="地理 Geo."></activiti:value>
          <activiti:value id="物理" name="物理 Phy."></activiti:value>
          <activiti:value id="生物" name="生物 Bio."></activiti:value>
          <activiti:value id="化学" name="化学 Chem."></activiti:value>
          <activiti:value id="体育" name="体育 P.E."></activiti:value>
          <activiti:value id="美术" name="美术 Art"></activiti:value>
          <activiti:value id="音乐" name="音乐 Music"></activiti:value>
          <activiti:value id="其它" name="其它 Other"></activiti:value>
        </activiti:formProperty>
        <activiti:formProperty id="tbhdpaymentpur002a_说明 Note_expdetail_8_string_t1_$$A" name="说明 Note" type="string" variable="tbhdpaymentpur002a_expdetail"></activiti:formProperty>
      </extensionElements>
    </userTask>
    <endEvent id="E1" name="E1">
      <extensionElements>
        <activiti:executionListener event="end" class="org.activiti.engine.impl.bpmn.listener.ScriptExecutionListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:string><![CDATA[if(execution.getVariable('_http_response_status_code')!= 200){
					def errorMessage = new XmlParser().parseText(execution.getVariable('_http_response_body').replaceAll("\\<\\?xml(.+?)\\?\\>", "").trim()).sendresult.resultdescription.text();
					throw new org.activiti.engine.ActivitiIllegalArgumentException(errorMessage+"请联系管理员 NC Exception");
				}]]></activiti:string>
          </activiti:field>
        </activiti:executionListener>
      </extensionElements>
    </endEvent>
    <endEvent id="E2" name="E2"></endEvent>
    <endEvent id="E3" name="E3"></endEvent>
    <sequenceFlow id="flow13" sourceRef="ST02" targetRef="ST03"></sequenceFlow>
    <sequenceFlow id="flow14" sourceRef="ST03" targetRef="ST04"></sequenceFlow>
    <sequenceFlow id="flow15" sourceRef="ST04" targetRef="ST05"></sequenceFlow>
    <sequenceFlow id="flow16" sourceRef="ST05" targetRef="ST06"></sequenceFlow>
    <sequenceFlow id="flow17" sourceRef="ST13" targetRef="CA01"></sequenceFlow>
    <exclusiveGateway id="exclusivegateway1" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="flow18" sourceRef="CA01" targetRef="exclusivegateway1"></sequenceFlow>
    <exclusiveGateway id="exclusivegateway2" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="flow21" sourceRef="UT01" targetRef="exclusivegateway2"></sequenceFlow>
    <exclusiveGateway id="exclusivegateway3" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="flow25" sourceRef="UT02" targetRef="exclusivegateway3"></sequenceFlow>
    <sequenceFlow id="flow1" sourceRef="S1" targetRef="ST01"></sequenceFlow>
    <sequenceFlow id="flow3" sourceRef="ST06" targetRef="ST07"></sequenceFlow>
    <sequenceFlow id="flow4" sourceRef="ST07" targetRef="ST08"></sequenceFlow>
    <sequenceFlow id="flow5" sourceRef="ST08" targetRef="ST09"></sequenceFlow>
    <sequenceFlow id="flow6" sourceRef="ST09" targetRef="ST10"></sequenceFlow>
    <sequenceFlow id="flow7" sourceRef="ST10" targetRef="ST11"></sequenceFlow>
    <sequenceFlow id="flow8" sourceRef="ST11" targetRef="ST12"></sequenceFlow>
    <sequenceFlow id="flow9" sourceRef="ST12" targetRef="ST13"></sequenceFlow>
    <exclusiveGateway id="exclusivegateway4" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="flow33" sourceRef="ST16" targetRef="ST17"></sequenceFlow>
    <sequenceFlow id="flow36" sourceRef="UT04" targetRef="UT06"></sequenceFlow>
    <sequenceFlow id="flow37" sourceRef="ST18" targetRef="E1"></sequenceFlow>
    <sequenceFlow id="flow38" sourceRef="UT05" targetRef="ST01"></sequenceFlow>
    <sequenceFlow id="flow39" sourceRef="ST01" targetRef="ST02"></sequenceFlow>
    <sequenceFlow id="flow41" sourceRef="ST14" targetRef="UT01"></sequenceFlow>
    <sequenceFlow id="flow42" sourceRef="UT06" targetRef="exclusivegateway5"></sequenceFlow>
    <exclusiveGateway id="exclusivegateway5" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="flow45" sourceRef="ST15" targetRef="ST16"></sequenceFlow>
    <sequenceFlow id="flow46" sourceRef="ST17" targetRef="exclusivegateway4"></sequenceFlow>
    <sequenceFlow id="flow48" sourceRef="UT07" targetRef="exclusivegateway3"></sequenceFlow>
    <sequenceFlow id="flow49" sourceRef="boundaryerror1" targetRef="UT07"></sequenceFlow>
    <endEvent id="E4" name="E4"></endEvent>
    <sequenceFlow id="flow50" sourceRef="exclusivegateway1" targetRef="E4">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${execution.getVariable('coreaction') == '彻底拒绝 Total rejection'}]]></conditionExpression>
    </sequenceFlow>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_DPPU002AO">
    <bpmndi:BPMNPlane bpmnElement="DPPU002AO" id="BPMNPlane_DPPU002AO">
      <bpmndi:BPMNShape bpmnElement="S1" id="BPMNShape_S1">
        <omgdc:Bounds height="35.0" width="35.0" x="29.0" y="65.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST01" id="BPMNShape_ST01">
        <omgdc:Bounds height="65.0" width="105.0" x="90.0" y="50.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST02" id="BPMNShape_ST02">
        <omgdc:Bounds height="65.0" width="105.0" x="210.0" y="50.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST03" id="BPMNShape_ST03">
        <omgdc:Bounds height="65.0" width="105.0" x="341.0" y="50.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST04" id="BPMNShape_ST04">
        <omgdc:Bounds height="65.0" width="105.0" x="475.0" y="50.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST05" id="BPMNShape_ST05">
        <omgdc:Bounds height="65.0" width="105.0" x="602.0" y="50.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST06" id="BPMNShape_ST06">
        <omgdc:Bounds height="61.0" width="105.0" x="602.0" y="130.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST07" id="BPMNShape_ST07">
        <omgdc:Bounds height="61.0" width="105.0" x="475.0" y="130.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST08" id="BPMNShape_ST08">
        <omgdc:Bounds height="61.0" width="105.0" x="341.0" y="130.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST09" id="BPMNShape_ST09">
        <omgdc:Bounds height="61.0" width="105.0" x="210.0" y="130.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST10" id="BPMNShape_ST10">
        <omgdc:Bounds height="61.0" width="105.0" x="210.0" y="210.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST11" id="BPMNShape_ST11">
        <omgdc:Bounds height="61.0" width="105.0" x="341.0" y="210.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST12" id="BPMNShape_ST12">
        <omgdc:Bounds height="61.0" width="105.0" x="475.0" y="210.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST13" id="BPMNShape_ST13">
        <omgdc:Bounds height="61.0" width="105.0" x="602.0" y="210.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="CA01" id="BPMNShape_CA01">
        <omgdc:Bounds height="65.0" width="105.0" x="341.0" y="280.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST14" id="BPMNShape_ST14">
        <omgdc:Bounds height="61.0" width="105.0" x="341.0" y="430.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="UT01" id="BPMNShape_UT01">
        <omgdc:Bounds height="71.0" width="105.0" x="341.0" y="510.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="UT02" id="BPMNShape_UT02">
        <omgdc:Bounds height="66.0" width="105.0" x="341.0" y="655.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST15" id="BPMNShape_ST15">
        <omgdc:Bounds height="65.0" width="105.0" x="480.0" y="724.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST16" id="BPMNShape_ST16">
        <omgdc:Bounds height="64.0" width="105.0" x="672.0" y="725.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST17" id="BPMNShape_ST17">
        <omgdc:Bounds height="61.0" width="105.0" x="672.0" y="825.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="boundaryerror1" id="BPMNShape_boundaryerror1">
        <omgdc:Bounds height="30.0" width="30.0" x="654.0" y="841.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="UT07" id="BPMNShape_UT07">
        <omgdc:Bounds height="70.0" width="105.0" x="341.0" y="821.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="UT04" id="BPMNShape_UT04">
        <omgdc:Bounds height="63.0" width="105.0" x="812.0" y="897.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="ST18" id="BPMNShape_ST18">
        <omgdc:Bounds height="65.0" width="105.0" x="813.0" y="1178.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="UT06" id="BPMNShape_UT06">
        <omgdc:Bounds height="61.0" width="105.0" x="812.0" y="985.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="UT05" id="BPMNShape_UT05">
        <omgdc:Bounds height="63.0" width="105.0" x="90.0" y="352.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E1" id="BPMNShape_E1">
        <omgdc:Bounds height="35.0" width="35.0" x="707.0" y="1193.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E2" id="BPMNShape_E2">
        <omgdc:Bounds height="35.0" width="35.0" x="602.0" y="608.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E3" id="BPMNShape_E3">
        <omgdc:Bounds height="35.0" width="35.0" x="219.0" y="800.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway1" id="BPMNShape_exclusivegateway1">
        <omgdc:Bounds height="40.0" width="40.0" x="373.0" y="363.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway2" id="BPMNShape_exclusivegateway2">
        <omgdc:Bounds height="40.0" width="40.0" x="373.0" y="605.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway3" id="BPMNShape_exclusivegateway3">
        <omgdc:Bounds height="40.0" width="40.0" x="373.0" y="736.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway4" id="BPMNShape_exclusivegateway4">
        <omgdc:Bounds height="40.0" width="40.0" x="704.0" y="908.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway5" id="BPMNShape_exclusivegateway5">
        <omgdc:Bounds height="40.0" width="40.0" x="844.0" y="1078.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E4" id="BPMNShape_E4">
        <omgdc:Bounds height="35.0" width="35.0" x="515.0" y="366.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow19" id="BPMNEdge_flow19">
        <omgdi:waypoint x="373.0" y="383.0"></omgdi:waypoint>
        <omgdi:waypoint x="195.0" y="383.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="267.0" y="390.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow40" id="BPMNEdge_flow40">
        <omgdi:waypoint x="393.0" y="403.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="430.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="393.0" y="403.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow22" id="BPMNEdge_flow22">
        <omgdi:waypoint x="373.0" y="625.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="655.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="48.0" x="306.0" y="621.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow23" id="BPMNEdge_flow23">
        <omgdi:waypoint x="373.0" y="625.0"></omgdi:waypoint>
        <omgdi:waypoint x="141.0" y="624.0"></omgdi:waypoint>
        <omgdi:waypoint x="142.0" y="415.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="48.0" x="220.0" y="632.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow31" id="BPMNEdge_flow31">
        <omgdi:waypoint x="413.0" y="625.0"></omgdi:waypoint>
        <omgdi:waypoint x="602.0" y="625.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="509.0" y="605.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow26" id="BPMNEdge_flow26">
        <omgdi:waypoint x="413.0" y="756.0"></omgdi:waypoint>
        <omgdi:waypoint x="480.0" y="756.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="48.0" x="410.0" y="735.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow29" id="BPMNEdge_flow29">
        <omgdi:waypoint x="373.0" y="756.0"></omgdi:waypoint>
        <omgdi:waypoint x="142.0" y="755.0"></omgdi:waypoint>
        <omgdi:waypoint x="142.0" y="415.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="48.0" x="231.0" y="736.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow32" id="BPMNEdge_flow32">
        <omgdi:waypoint x="373.0" y="756.0"></omgdi:waypoint>
        <omgdi:waypoint x="236.0" y="756.0"></omgdi:waypoint>
        <omgdi:waypoint x="236.0" y="800.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="241.0" y="779.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow34" id="BPMNEdge_flow34">
        <omgdi:waypoint x="744.0" y="928.0"></omgdi:waypoint>
        <omgdi:waypoint x="812.0" y="928.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="48.0" x="744.0" y="928.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow35" id="BPMNEdge_flow35">
        <omgdi:waypoint x="724.0" y="948.0"></omgdi:waypoint>
        <omgdi:waypoint x="724.0" y="1193.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="648.0" y="984.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow43" id="BPMNEdge_flow43">
        <omgdi:waypoint x="864.0" y="1118.0"></omgdi:waypoint>
        <omgdi:waypoint x="865.0" y="1178.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="864.0" y="1118.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow44" id="BPMNEdge_flow44">
        <omgdi:waypoint x="884.0" y="1098.0"></omgdi:waypoint>
        <omgdi:waypoint x="953.0" y="1097.0"></omgdi:waypoint>
        <omgdi:waypoint x="953.0" y="1014.0"></omgdi:waypoint>
        <omgdi:waypoint x="953.0" y="928.0"></omgdi:waypoint>
        <omgdi:waypoint x="917.0" y="928.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="72.0" x="954.0" y="1033.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow13" id="BPMNEdge_flow13">
        <omgdi:waypoint x="315.0" y="82.0"></omgdi:waypoint>
        <omgdi:waypoint x="341.0" y="82.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow14" id="BPMNEdge_flow14">
        <omgdi:waypoint x="446.0" y="82.0"></omgdi:waypoint>
        <omgdi:waypoint x="475.0" y="82.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow15" id="BPMNEdge_flow15">
        <omgdi:waypoint x="580.0" y="82.0"></omgdi:waypoint>
        <omgdi:waypoint x="602.0" y="82.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow16" id="BPMNEdge_flow16">
        <omgdi:waypoint x="654.0" y="115.0"></omgdi:waypoint>
        <omgdi:waypoint x="654.0" y="130.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow17" id="BPMNEdge_flow17">
        <omgdi:waypoint x="654.0" y="271.0"></omgdi:waypoint>
        <omgdi:waypoint x="654.0" y="312.0"></omgdi:waypoint>
        <omgdi:waypoint x="446.0" y="312.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow18" id="BPMNEdge_flow18">
        <omgdi:waypoint x="393.0" y="345.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="363.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow21" id="BPMNEdge_flow21">
        <omgdi:waypoint x="393.0" y="581.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="605.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow25" id="BPMNEdge_flow25">
        <omgdi:waypoint x="393.0" y="721.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="736.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
        <omgdi:waypoint x="64.0" y="82.0"></omgdi:waypoint>
        <omgdi:waypoint x="90.0" y="82.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
        <omgdi:waypoint x="602.0" y="160.0"></omgdi:waypoint>
        <omgdi:waypoint x="580.0" y="160.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
        <omgdi:waypoint x="475.0" y="160.0"></omgdi:waypoint>
        <omgdi:waypoint x="446.0" y="160.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow5" id="BPMNEdge_flow5">
        <omgdi:waypoint x="341.0" y="160.0"></omgdi:waypoint>
        <omgdi:waypoint x="315.0" y="160.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow6" id="BPMNEdge_flow6">
        <omgdi:waypoint x="262.0" y="191.0"></omgdi:waypoint>
        <omgdi:waypoint x="262.0" y="210.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow7" id="BPMNEdge_flow7">
        <omgdi:waypoint x="315.0" y="240.0"></omgdi:waypoint>
        <omgdi:waypoint x="341.0" y="240.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow8" id="BPMNEdge_flow8">
        <omgdi:waypoint x="446.0" y="240.0"></omgdi:waypoint>
        <omgdi:waypoint x="475.0" y="240.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow9" id="BPMNEdge_flow9">
        <omgdi:waypoint x="580.0" y="240.0"></omgdi:waypoint>
        <omgdi:waypoint x="602.0" y="240.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow33" id="BPMNEdge_flow33">
        <omgdi:waypoint x="724.0" y="789.0"></omgdi:waypoint>
        <omgdi:waypoint x="724.0" y="825.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow36" id="BPMNEdge_flow36">
        <omgdi:waypoint x="864.0" y="960.0"></omgdi:waypoint>
        <omgdi:waypoint x="864.0" y="985.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow37" id="BPMNEdge_flow37">
        <omgdi:waypoint x="813.0" y="1210.0"></omgdi:waypoint>
        <omgdi:waypoint x="742.0" y="1210.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow38" id="BPMNEdge_flow38">
        <omgdi:waypoint x="142.0" y="352.0"></omgdi:waypoint>
        <omgdi:waypoint x="142.0" y="115.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow39" id="BPMNEdge_flow39">
        <omgdi:waypoint x="195.0" y="82.0"></omgdi:waypoint>
        <omgdi:waypoint x="210.0" y="82.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow41" id="BPMNEdge_flow41">
        <omgdi:waypoint x="393.0" y="491.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="510.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow42" id="BPMNEdge_flow42">
        <omgdi:waypoint x="864.0" y="1046.0"></omgdi:waypoint>
        <omgdi:waypoint x="864.0" y="1078.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow45" id="BPMNEdge_flow45">
        <omgdi:waypoint x="585.0" y="756.0"></omgdi:waypoint>
        <omgdi:waypoint x="672.0" y="757.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow46" id="BPMNEdge_flow46">
        <omgdi:waypoint x="724.0" y="886.0"></omgdi:waypoint>
        <omgdi:waypoint x="724.0" y="908.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow48" id="BPMNEdge_flow48">
        <omgdi:waypoint x="393.0" y="821.0"></omgdi:waypoint>
        <omgdi:waypoint x="393.0" y="776.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow49" id="BPMNEdge_flow49">
        <omgdi:waypoint x="654.0" y="856.0"></omgdi:waypoint>
        <omgdi:waypoint x="446.0" y="856.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow50" id="BPMNEdge_flow50">
        <omgdi:waypoint x="413.0" y="383.0"></omgdi:waypoint>
        <omgdi:waypoint x="515.0" y="383.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>