<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/inv">
  <process id="SRM_invoice" name="SRM采购开票流程" isExecutable="true" activiti:candidateStarterGroups="FININV,admin">
    <startEvent id="S1" name="S1" activiti:initiator="initiator">
    	<extensionElements>
    		<activiti:formProperty id="executeFrom_开始时间_1_string_t3_$$A" name="开始时间" type="string" variable="executeFrom" required="true"/>
    		<activiti:formProperty id="executeTo_结束时间_2_string_t3_$$A" name="结束时间" type="string" variable="executeTo" required="true"/>
    		
    		<activiti:executionListener event="end" class="org.activiti.engine.impl.bpmn.listener.ScriptExecutionListener">
    			<activiti:field name="language">
    				<activiti:string>
    					<![CDATA[groovy]]>
    				</activiti:string>
    			</activiti:field>
    			<activiti:field name="script">
    				<activiti:string>
    					<![CDATA[import com.eorionsolution.bpms.extension.rest.RestAPI
    						import groovy.json.JsonSlurper
    						import groovy.json.JsonOutput
    						
    						def jsonSlurper = new JsonSlurper()
    						def from_ = (executeFrom.toLong()/1000).toString()
    						def to_ = (executeTo.toLong()/1000).toString()
    						//调用metabase获取该时间段内所有采购明细
    						def restParam = new HashMap<String,Object>()
    						def headerMap = new HashMap<String,String>()
    						headerMap.put("Content-Type","application/json")
    						restParam.put("_http_method","GET")
    						restParam.put("_http_headers",headerMap)
    						def param=java.net.URLEncoder.encode('[{"type":"category","target":["variable",["template-tag","from_"]],"value":\"'+ from_+ '\"},{"type":"category","target":["variable",["template-tag","to_"]],"value":\"'+ to_+ '\"}]', "UTF-8")
    						restParam.put("_http_url", 'https://metabase.eorionsolution.com/public/question/5806fda5-b006-45cc-942b-edce145d7d89.json?parameters=' + param)
    						restParam.put("_http_body", '')
    						def result = RestAPI.execute(restParam)
    						if (!result._http_response_status_code || !result._http_response_status_code.toString().startsWith("2")) {
				    			throw new org.activiti.engine.ActivitiIllegalArgumentException('metabase调用失败')
				    		}
				    		def responseBody = jsonSlurper.parseText(result._http_response_body)
				    		
				    		if(responseBody.size() == 0) {
				    			throw new org.activiti.engine.ActivitiIllegalArgumentException('当前时间段内没有已完成的采购流程')
				    		}
				    		
				    		def dList = []
				    		def vs = new HashSet()
				    		responseBody.each {
				    			def item = jsonSlurper.parseText(it.tbhddetail_item)
				    			item.rows.each {
				    				vs.add(it[1])
				    			}
				    		}
				    		execution.setVariable('tt',JsonOutput.toJson(vs))
				    		//item分组
				    		vs.each { v->
				    			def initMap = new HashMap()
				    			initMap.put('headers', jsonSlurper.parseText(responseBody[0].tbhddetail_item).headers)
				    			initMap.put('name', jsonSlurper.parseText(responseBody[0].tbhddetail_item).name)
				    			initMap.put('tableName', 'tbhddetail')
				    			def rows = []
				    			responseBody.each{item->
				    				def ite = jsonSlurper.parseText(item.tbhddetail_item)
			    					def li = ite.rows
			    					li.each {
			    						if (v==it[1]) {
			    							rows<<it
			    						}
			    					}
				    			}
				    			initMap.put('rows',rows)
				    			
				    			def curStd = []
				    			responseBody.each{std->
				    				def li = jsonSlurper.parseText(std.tbhddetail_item_std)
				    				li.each {
				    					if (v==it.vndid) {
				    						curStd<<it
				    					}
				    				}
				    			}
				    			
				    			dList<<[initMap, curStd]
				    		}
				    		
				    		execution.setVariable('test', JsonOutput.toJson(dList))
				    		
    					]]>
    				</activiti:string>
    			</activiti:field>
    		</activiti:executionListener>
    	</extensionElements>
    </startEvent>
    <subProcess id="subprocess1" name="供应商分组开票">
      <multiInstanceLoopCharacteristics isSequential="false" activiti:collection="pList" activiti:elementVariable="info">
      	<completionCondition>${nrOfCompletedInstances/nrOfInstances == 1}</completionCondition>
      </multiInstanceLoopCharacteristics>
      <startEvent id="startevent2" name="Start">
      	<extensionElements>
      		<activiti:executionListener event="end" class="org.activiti.engine.impl.bpmn.listener.ScriptExecutionListener">
      			<activiti:field name="language">
      				<activiti:string>
      					<![CDATA[groovy]]>
      				</activiti:string>
      			</activiti:field>
      			<activiti:field name="script">
      				<activiti:string>
      					<![CDATA[import groovy.json.JsonOutput
      						def items = info[0]
      						def stds = info[1]
      						execution.setVariable('tbhddetail_item', JsonOutput.toJson(items))
      						execution.setVariable('tbhddetail_item_std', JsonOutput.toJson(stds))
      					]]>
      				</activiti:string>
      			</activiti:field>
      		</activiti:executionListener>
      	</extensionElements>
      </startEvent>
      <userTask id="usertask1" name="magna修改开票明细" activiti:assignee="${initiator}" activiti:dueDate="P1D" activiti:priority="8080">
      	<extensionElements>
    		<activiti:formProperty id="tbhddetail_item" name="采购计划明细 Detail" type="string" variable="tbhddetail_item"/>
    		<activiti:formProperty id="tbhddetail_计划主题_subject_1_string_t1_$$VA" name="计划主题" variable="tbhddetail_subject_t00"/>
    		<activiti:formProperty id="tbhddetail_供应商id_vndid_2_string_t1_$$VA" name="供应商id" variable="tbhddetail_vndid_t00"/>
    		<activiti:formProperty id="tbhddetail_物料信息_matinfo_3_string_tree_$$VA" name="物料信息" type="string" variable="tbhddetail_matinfo_t00"/>
    		<activiti:formProperty id="tbhddetail_计划数量_planqty_4_string_t11_$$VA" name="计划数量" type="string" variable="tbhddetail_planqty_t00"/>
    		<activiti:formProperty id="tbhddetail_剩余数量_remainqty_5_string_t11_$$VA" name="剩余数量" type="string" variable="tbhddetail_remainqty_t00"/>
    		<activiti:formProperty id="tbhddetail_单价_prcprice_6_string_t11_$$VA" name="单价" type="string" variable="tbhddetail_prcprice_t00"/>
    		<activiti:formProperty id="tbhddetail_订货日期_orderdate_7_string_t3_$$A" name="订货日期" type="string" variable="tbhddetail_orderdate_t00"/>
    		<activiti:formProperty id="tbhddetail_订货数量_orderqty_8_string_t11_$$A" name="订货数量" type="string" variable="tbhddetail_orderqty_t00"/>
    		<activiti:formProperty id="tbhddetail_系统批次_sysBatch_9_string_t1_$$VA" name="系统批次" type="string" variable="tbhddetail_sysBatch_t00"/>
    		<activiti:formProperty id="tbhddetail_手工批次_batch_10_string_t1_$$VA" name="手工批次" type="string" variable="tbhddetail_batch_t00"/>
    		<activiti:formProperty id="tbhddetail_实际送货数量_deliveryqty_11_string_t11_$$VA" name="实际送货数量" type="string" variable="tbhddetail_deliveryqty_t00"/>
    		<activiti:formProperty id="tbhddetail_送货日期_deliverydate_12_string_t3_$$VA" name="送货日期" type="string" variable="tbhddetail_deliverydate_t00"/>
    		<activiti:formProperty id="tbhddetail_车次_trainnumber_13_enum_sbs_$$VA" name="车次" type="enum" variable="tbhddetail_trainnumber_t00">
				<activiti:value id="车次1" name="车次1"/>
				<activiti:value id="车次2" name="车次2"/>
				<activiti:value id="车次3" name="车次3"/>
				<activiti:value id="车次4" name="车次4"/> 	
      		</activiti:formProperty>
    		<activiti:formProperty id="tbhddetail_到货日期_arrivaldate_14_string_t3_$$VA" name="到货日期" type="string" variable="tbhddetail_arrivaldate_t00"/>
    		<activiti:formProperty id="tbhddetail_合格数_accnumber_15_string_t11_$$VA" name="合格数" type="string" variable="tbhddetail_accnumber_t00"/>
    		<activiti:formProperty id="tbhddetail_不合格数_defnumber_16_string_t11_$$VA" name="不合格数" type="string" variable="tbhddetail_defnumber_t00"/>
    		<activiti:formProperty id="tbhddetail_不合格总金额_defAmount_17_string_t11_$$VA" name="不合格总金额" type="string" variable="tbhddetail_defAmount_t00"/>
    		<activiti:formProperty id="tbhddetail_实际总金额_amount_18_string_t11_$$A" name="实际总金额" type="string" variable="tbhddetail_amount_t00"/>
      		
      		<activiti:taskListener event="complete" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
      			<activiti:field name="language">
      				<activiti:string>
      					<![CDATA[groovy]]>
      				</activiti:string>
      			</activiti:field>
      			<activiti:field name="script">
      				<activiti:string>
      					<![CDATA[import com.eorionsolution.bpms.extension.rest.RestAPI
      						import groovy.json.JsonSlurper
    						import groovy.json.JsonOutput
    						import java.text.SimpleDateFormat
    						import java.text.DateFormat
      						
      						def execution = task.getExecution()
      						def jsonSlurper = new JsonSlurper()
      						DateFormat df = new SimpleDateFormat("yyyyMMddHHmmss")
      						
      						//生成系统批次
      						def std = jsonSlurper.parseText(tbhddetail_item_std)
      						def item = jsonSlurper.parseText(tbhddetail_item)
      						std.each{
      							if (!it.orderdate) {
      								throw new org.activiti.engine.ActivitiIllegalArgumentException('请填写订货日期')
      							}
      							if (!it.orderqty) {
      								throw new org.activiti.engine.ActivitiIllegalArgumentException('请填写订货数量')
      							}
      							it.sysBatch = df.format(new Date(it.orderdate.toLong()))
      						}
      						item.each {k,v ->
      							if (k == 'rows') {
      								v.each {
      									it[8] = df.format(new Date(it[6].toLong()))
      								}
      							}
      						}
      						execution.setVariable('tbhddetail_item_std', JsonOutput.toJson(std))
      						execution.setVariable('tbhddetail_item', JsonOutput.toJson(item))
      						
      						//微信通知供应商
      						def restParam = new HashMap<String,Object>()
				    		def headerMap = new HashMap<String,String>()
				    		
				    		def bodyMap = new HashMap()
							bodyMap.put('touser', 'baocaixue@eorionsolution.com')
							bodyMap.put('agentid',1000005)
							bodyMap.put('title', 'magna已发起采购需求')
							bodyMap.put('description', '供应商提醒：magna有采购需求，请尽快于BPMS确认')
							bodyMap.put('url','https://bpms.eorionsolution.com/bpmssrm/task.html?processInstanceId=' + procInstId)
							def body = JsonOutput.toJson(bodyMap)
				    		
				    		headerMap.put("Content-Type","application/json")			
							restParam.put("_http_method","POST")
							restParam.put("_http_headers",headerMap)
							restParam.put("_http_url", 'https://bpms.eorionsolution.com/wso2esb/wechat/message/send');
							restParam.put("_http_body", body)
				    		def result = RestAPI.execute(restParam)
				    		
				    		if (!result._http_response_status_code || !result._http_response_status_code.toString().startsWith("2")) {
				    			throw new org.activiti.engine.ActivitiIllegalArgumentException('微信通知失败，请联系管理员')
				    		}
      					]]>
      				</activiti:string>
      			</activiti:field>
      		</activiti:taskListener>
    	</extensionElements>
      </userTask>
      <exclusiveGateway id="exclusivegateway1" name="Exclusive Gateway"></exclusiveGateway>
      <userTask id="usertask2" name="供应商填写单据编号"></userTask>
      <userTask id="usertask3" name="财务"></userTask>
      <userTask id="usertask4" name="magna填写索赔信息"></userTask>
      <userTask id="usertask5" name="供应商确认索赔"></userTask>
      <userTask id="usertask6" name="财务"></userTask>
      <sequenceFlow id="flow2" sourceRef="startevent2" targetRef="usertask1"></sequenceFlow>
      <sequenceFlow id="flow3" sourceRef="usertask1" targetRef="exclusivegateway1"></sequenceFlow>
      <sequenceFlow id="flow4" name="需要索赔" sourceRef="exclusivegateway1" targetRef="usertask4"></sequenceFlow>
      <sequenceFlow id="flow5" sourceRef="usertask4" targetRef="usertask5"></sequenceFlow>
      <sequenceFlow id="flow6" sourceRef="usertask5" targetRef="usertask6"></sequenceFlow>
      <endEvent id="E1" name="E1"></endEvent>
      <sequenceFlow id="flow7" sourceRef="usertask6" targetRef="E1"></sequenceFlow>
      <sequenceFlow id="flow8" name="不需索赔" sourceRef="exclusivegateway1" targetRef="usertask2"></sequenceFlow>
      <sequenceFlow id="flow9" sourceRef="usertask2" targetRef="usertask3"></sequenceFlow>
      <endEvent id="E2" name="E2"></endEvent>
      <sequenceFlow id="flow10" sourceRef="usertask3" targetRef="E2"></sequenceFlow>
    </subProcess>
    <sequenceFlow id="flow1" sourceRef="S1" targetRef="subprocess1"></sequenceFlow>
    <endEvent id="E3" name="E3"></endEvent>
    <sequenceFlow id="flow11" sourceRef="subprocess1" targetRef="E3"></sequenceFlow>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_SRM_invoice">
    <bpmndi:BPMNPlane bpmnElement="SRM_invoice" id="BPMNPlane_SRM_invoice">
      <bpmndi:BPMNShape bpmnElement="S1" id="BPMNShape_S1">
        <omgdc:Bounds height="35.0" width="35.0" x="30.0" y="200.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="subprocess1" id="BPMNShape_subprocess1">
        <omgdc:Bounds height="321.0" width="791.0" x="90.0" y="60.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="startevent2" id="BPMNShape_startevent2">
        <omgdc:Bounds height="35.0" width="35.0" x="110.0" y="200.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask1" id="BPMNShape_usertask1">
        <omgdc:Bounds height="61.0" width="111.0" x="180.0" y="187.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway1" id="BPMNShape_exclusivegateway1">
        <omgdc:Bounds height="40.0" width="40.0" x="320.0" y="197.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask2" id="BPMNShape_usertask2">
        <omgdc:Bounds height="61.0" width="111.0" x="390.0" y="260.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask3" id="BPMNShape_usertask3">
        <omgdc:Bounds height="61.0" width="111.0" x="550.0" y="260.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask4" id="BPMNShape_usertask4">
        <omgdc:Bounds height="61.0" width="111.0" x="390.0" y="127.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask5" id="BPMNShape_usertask5">
        <omgdc:Bounds height="61.0" width="111.0" x="550.0" y="127.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask6" id="BPMNShape_usertask6">
        <omgdc:Bounds height="61.0" width="111.0" x="680.0" y="127.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E1" id="BPMNShape_E1">
        <omgdc:Bounds height="35.0" width="35.0" x="836.0" y="140.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E2" id="BPMNShape_E2">
        <omgdc:Bounds height="35.0" width="35.0" x="706.0" y="273.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="E3" id="BPMNShape_E3">
        <omgdc:Bounds height="35.0" width="35.0" x="926.0" y="203.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2">
        <omgdi:waypoint x="145.0" y="217.0"></omgdi:waypoint>
        <omgdi:waypoint x="180.0" y="217.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
        <omgdi:waypoint x="291.0" y="217.0"></omgdi:waypoint>
        <omgdi:waypoint x="320.0" y="217.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
        <omgdi:waypoint x="340.0" y="197.0"></omgdi:waypoint>
        <omgdi:waypoint x="340.0" y="156.0"></omgdi:waypoint>
        <omgdi:waypoint x="390.0" y="157.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="16.0" width="100.0" x="289.0" y="121.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow5" id="BPMNEdge_flow5">
        <omgdi:waypoint x="501.0" y="157.0"></omgdi:waypoint>
        <omgdi:waypoint x="550.0" y="157.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow6" id="BPMNEdge_flow6">
        <omgdi:waypoint x="661.0" y="157.0"></omgdi:waypoint>
        <omgdi:waypoint x="680.0" y="157.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow7" id="BPMNEdge_flow7">
        <omgdi:waypoint x="791.0" y="157.0"></omgdi:waypoint>
        <omgdi:waypoint x="836.0" y="157.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow8" id="BPMNEdge_flow8">
        <omgdi:waypoint x="340.0" y="237.0"></omgdi:waypoint>
        <omgdi:waypoint x="340.0" y="289.0"></omgdi:waypoint>
        <omgdi:waypoint x="390.0" y="290.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="16.0" width="100.0" x="296.0" y="300.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow9" id="BPMNEdge_flow9">
        <omgdi:waypoint x="501.0" y="290.0"></omgdi:waypoint>
        <omgdi:waypoint x="550.0" y="290.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow10" id="BPMNEdge_flow10">
        <omgdi:waypoint x="661.0" y="290.0"></omgdi:waypoint>
        <omgdi:waypoint x="706.0" y="290.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
        <omgdi:waypoint x="65.0" y="217.0"></omgdi:waypoint>
        <omgdi:waypoint x="90.0" y="220.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow11" id="BPMNEdge_flow11">
        <omgdi:waypoint x="881.0" y="220.0"></omgdi:waypoint>
        <omgdi:waypoint x="926.0" y="220.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>